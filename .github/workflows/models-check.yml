name: Check Models

on: 
  pull_request:
    paths:
      - 'models/**'

jobs:
  check-models:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Fetch base branch
        run: git fetch origin ${{ github.base_ref }}

      - name: Check for deleted models and fail if any are found
        run: |
          deleted_models=$(git diff --name-status origin/${{ github.base_ref }} -- models | grep '^D' | wc -l)
          if [ "$deleted_models" -gt 0 ]; then
            echo "Error: Deleted models found."
            exit 1
          fi

      - name: Check for renamed models and fail if any are found
        run: |
          renamed_models=$(git diff --name-status origin/${{ github.base_ref }} -- models | grep '^R' | wc -l)
          if [ "$renamed_models" -gt 0 ]; then
            echo "Error: Renamed models found."
            exit 1
          fi

      - name: Check for modified models and fail if lines removed and ignore comments and whitespace-only lines
        run: |
          modified_models=$(git diff --name-only origin/${{ github.base_ref }} -- models | grep -E '\.cs$')
          if [ -n "$modified_models" ]; then
            for model in $modified_models; do
              lines_removed=$(git diff origin/${{ github.base_ref }} -- "$model" | grep '^-' | grep -vE '^-\s*(//|///)?\s*$' | grep -v '^---')
              if [ "$lines_removed" -gt 0 ]; then
                echo "Error: Lines removed in modified model $model."
                exit 1
              fi
            done
          fi

              
      - name: Passed 
        run: echo "All checks passed. No models were modified or deleted, and no lines were removed or changed in added/renamed files."
        if: success()
        
      - name: Failed
        run: echo "Checks failed. Please review the modified or deleted models and ensure no lines were removed or changed in added/renamed files."
        if: failure()  