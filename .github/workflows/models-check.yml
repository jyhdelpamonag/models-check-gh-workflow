name: Check Models

on: 
  pull_request:
    paths:
      - 'models/**'

jobs:
  check-models:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Fetch base branch
        run: git fetch origin ${{ github.base_ref }}

      - name: Check for deleted models and fail if any are found
        run: |
          deleted_models=$(git diff --name-status origin/${{ github.base_ref }} -- models | grep '^D' | wc -l)
          if [ "$deleted_models" -gt 0 ]; then
            echo "Error: Deleted models found."
            exit 1
          fi

      - name: Check for renamed models and fail if any are found
        run: |
          renamed_models=$(git diff --name-status origin/${{ github.base_ref }} -- models | grep '^R' | wc -l)
          if [ "$renamed_models" -gt 0 ]; then
            echo "Error: Renamed models found."
            exit 1
          fi

      - name: Check for modified models and fail if existing properties are removed
        run: |
          modified_models=$(git diff --name-status origin/${{ github.base_ref }} -- models | grep '^M' | wc -l)
          if [ "$modified_models" -gt 0 ]; then
            echo "Checking for removed properties in modified models..."
            for file in $(git diff --name-only origin/${{ github.base_ref }} -- models); do
              if git diff origin/${{ github.base_ref }} -- "$file" | grep -q '^-[^+]' ; then
                echo "Error: Removed properties found in $file."
                exit 1
              fi
            done
          fi
              
      - name: Passed 
        run: echo "All checks passed. No models were modified or deleted, and no lines were removed or changed in added/renamed files."
        if: success()
        
      - name: Failed
        run: echo "Checks failed. Please review the modified or deleted models and ensure no lines were removed or changed in added/renamed files."
        if: failure()  